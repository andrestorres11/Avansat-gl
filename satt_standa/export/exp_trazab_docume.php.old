<?php
error_reporting("E_ERROR");

include ("../lib/general/constantes.inc");
include ("../lib/general/conexion_lib.inc");
include ("../lib/general/form_lib.inc");
include ("../lib/general/paginador_lib.inc");
include ("../lib/general/pdf_lib.inc");
include ("../lib/general/tabla_lib.inc");
include ("../despac/Despachos.inc");
include("../../".$GLOBALS['url']."/constantes.inc");

class Proc_exp_tradoc
{
 var $conexion;

 function Proc_exp_tradoc()
 {
  $this -> conexion = new Conexion("localhost", USUARIO, CLAVE, $GLOBALS["db"]);
  $this -> Listar();
 }

 function Listar()
 {
  $archivo = "Trazabilidad_de_Documentos_".date("Y_m_d");
    
  $query = "SELECT a.num_despac,a.cod_manifi,k.nom_remdes,j.val_pesoxx,
                    j.num_docume,j.num_pedido,a.cod_ciuori,j.cod_ciudad,
                    f.abr_tercer,d.num_placax,e.abr_tercer,
                    DATE_FORMAT(a.fec_despac,'%H:%i %d-%m-%Y'),
                    DATE_FORMAT(a.fec_salida,'%H:%i %d-%m-%Y'),
                    DATE_FORMAT(a.fec_llegad,'%H:%i %d-%m-%Y'),
                    a.ind_anulad,j.cod_remdes,
                    if(m.ind_tonela = '".COD_ESTADO_ACTIVO."',m.val_costos / m.can_tonela,m.val_costos),
   			        if(m.ind_tonela = '".COD_ESTADO_ACTIVO."',(m.val_costos / m.can_tonela) * j.val_pesoxx,m.val_costos),
   			        if(j.cod_tabfle IS NOT NULL,l.nom_trayec,'-'),
   			        if(m.ind_tonela != '".COD_ESTADO_ACTIVO."',' (Viaje)',''),
   			        a.cod_ciudes
               FROM ".BASE_DATOS.".tab_despac_vehige d,
                    ".BASE_DATOS.".tab_tercer_tercer e,
                    ".BASE_DATOS.".tab_tercer_tercer f,
                    ".BASE_DATOS.".tab_vehicu_vehicu i,
                    ".BASE_DATOS.".tab_despac_despac a LEFT JOIN
                    ".BASE_DATOS.".tab_despac_remdes j ON
                    a.num_despac = j.num_despac LEFT JOIN
                    ".BASE_DATOS.".tab_genera_remdes k ON
                    j.cod_remdes = k.cod_remdes LEFT JOIN
                    ".BASE_DATOS.".tab_tablax_fletes m ON
                    j.cod_tabfle = m.cod_consec LEFT JOIN
                    ".BASE_DATOS.".tab_genera_trayec l ON
                    m.cod_trayec = l.cod_trayec
              WHERE a.num_despac = d.num_despac AND
                    d.cod_conduc = e.cod_tercer AND
                    d.cod_transp = f.cod_tercer AND
                    k.cod_remdes = j.cod_remdes AND
                    i.num_placax = d.num_placax
			";  

  if($GLOBALS[eciuori])
   $query .= " AND a.cod_ciuori = ".$GLOBALS[eciuori]."";
  if($GLOBALS[eciudes])
   $query .= " AND a.cod_ciudes = ".$GLOBALS[eciudes]."";
  if($GLOBALS[econduc])
   $query .= " AND d.cod_conduc = '".$GLOBALS[econduc]."'";
  if($GLOBALS[etransp])
   $query .= " AND d.cod_transp = '".$GLOBALS[etransp]."'";
  if($GLOBALS[edespac])
   $query .= " AND a.num_despac = ".$GLOBALS[edespac]."";
  if($GLOBALS[edocume])
   $query .= " AND a.cod_manifi = '".$GLOBALS[edocume]."'";
  if($GLOBALS[eremisi])
   $query .= " AND j.num_docume = '".$GLOBALS[eremisi]."'";
  if($GLOBALS[epedido])
   $query .= " AND j.num_pedido = '".$GLOBALS[epedido]."'";
  if($GLOBALS[eplacax])
   $query .= " AND d.num_placax = '".$GLOBALS[eplacax]."'";
  if($GLOBALS[edestinat])
   $query .= " AND j.cod_remdes = '".$GLOBALS[edestinat]."'";

  if($GLOBALS[transp])
   $query .= " AND d.cod_transp = '".$GLOBALS[transp]."'";
  if($GLOBALS[despac])
   $query .= " AND a.num_despac = ".$GLOBALS[despac]."";
  if($GLOBALS[docume])
   $query .= " AND a.cod_manifi = '".$GLOBALS[docume]."'";
  if($GLOBALS[remisi])
   $query .= " AND j.num_docume = '".$GLOBALS[remisi]."'";
  if($GLOBALS[pedido])
   $query .= " AND j.num_pedido = '".$GLOBALS[pedido]."'";
  if($GLOBALS[placax])
   $query .= " AND d.num_placax = '".$GLOBALS[placax]."'";
  if($GLOBALS[conduc])
   $query .= " AND d.cod_conduc = '".$GLOBALS[conduc]."'";
  if($GLOBALS[ciuori])
   $query .= " AND a.cod_ciuori = ".$GLOBALS[ciuori]."";
  if($GLOBALS[ciudes])
   $query .= " AND a.cod_ciudes = ".$GLOBALS[ciudes]."";
  
  $query .= " AND a.fec_despac BETWEEN '".$GLOBALS[fi]."' AND '".$GLOBALS[ff]."'";
  $query .=  " GROUP BY j.num_despac,j.cod_remdes ORDER BY 1,3,4";  
  //echo $query;
  $consulta = new Consulta($query, $this -> conexion);
  $despac = $consulta -> ret_matriz();
  $this -> expListadoExcel($archivo,$despac);
 }

 function expListadoExcel($archivo,$despac)
 {
  $archivo .= ".xls";

  header('Content-Type: application/octetstream');
  header('Expires: 0');
  header('Content-Disposition: attachment; filename="'.$archivo.'"');
  header('Cache-Control: must-revalidate, post-check=0, pre-check=0');
  header('Pragma: public');

  $formulario = new Formulario ("index.php","post","Trazabilidad de Documentos","form_item");
  $formulario -> linea ("Se Encontro un Total de ".sizeof($despac)." Documento(s).",1,"t2");

  $formulario -> nueva_tabla();
  $formulario -> linea("Despacho",0,"t");
  $formulario -> linea("Documento/Despacho",0,"t");
  $formulario -> linea("Desposito/Destinatario",0,"t");
  $formulario -> linea("Remisi&oacute;n",0,"t");
  $formulario -> linea("Pedido",0,"t");
  $formulario -> linea("Origen",0,"t");
  $formulario -> linea("Destino",0,"t");
  $formulario -> linea ("Peso (Tn)",0,"t");
  $formulario -> linea ("Valor (Unit)",0,"t");
  $formulario -> linea ("Valor Flete",0,"t");
  $formulario -> linea ("Trayecto",0,"t");
  $formulario -> linea("Transportadora",0,"t");
  $formulario -> linea("Placa",0,"t");
  $formulario -> linea("Conductor",0,"t");
  $formulario -> linea("Fecha/Despacho",0,"t");
  $formulario -> linea("Fecha/Salida",0,"t");
  $formulario -> linea("Fecha/Llegada",0,"t");
  $formulario -> linea("Estado",1,"t");
  
  for($i = 0; $i < sizeof($despac); $i++)
  {
   $query = "SELECT nom_ciudad
             FROM ".BASE_DATOS.".tab_genera_ciudad
             WHERE cod_ciudad = ".$despac[$i][6]."             
            ";
           
    $consulta = new Consulta($query, $this -> conexion);
    $ciudad_o = $consulta -> ret_matriz();

    $query = "SELECT nom_ciudad
             FROM ".BASE_DATOS.".tab_genera_ciudad
             WHERE cod_ciudad = ".$despac[$i][20]."             
            ";
           
    $consulta = new Consulta($query, $this -> conexion);
    $ciudad_d = $consulta -> ret_matriz();
    
   if($despac[$i][14] == "R")
   {
   	$estado = "Activo";
   	$estilo = "i";
   }
   else if($despac[$i][12] == "A")
   {
   	$estado = "Anulado";
   	$estilo = "ie";
   }   
   
   $formulario -> linea ($despac[$i][0],0,$estilo);
   $formulario -> linea ($despac[$i][1],0,$estilo);
   $formulario -> linea ($despac[$i][2],0,$estilo);
   $formulario -> linea ($despac[$i][4],0,$estilo);   
   $formulario -> linea ($despac[$i][5],0,$estilo);
   $formulario -> linea ($ciudad_o[0][0],0,$estilo);
   $formulario -> linea ($ciudad_d[0][0],0,$estilo);
   $formulario -> linea ($despac[$i][3],0,$estilo);    
   $formulario -> linea ($despac[$i][16].$despac[$i][19],0,$estilo);
   $formulario -> linea ($despac[$i][17],0,$estilo);
   $formulario -> linea ($despac[$i][18],0,$estilo); 
   $formulario -> linea ($despac[$i][8],0,$estilo);
   $formulario -> linea ($despac[$i][9],0,$estilo);
   $formulario -> linea ($despac[$i][10],0,$estilo);
   $formulario -> linea ($despac[$i][11],0,$estilo);
   $formulario -> linea ($despac[$i][12],0,$estilo);
   $formulario -> linea ($despac[$i][13],0,$estilo);
   $formulario -> linea ($estado,1,$estilo);
  }
 }
}
/*
class PDF extends FPDF
{
 function Header()
 {
  $this->SetFont('Arial','B',8);
 }

 function Footer()
 {
  $this -> SetY(-15);
  $this -> SetFont('Arial','I',8);
  $this -> Cell(0,10,'Page '.$this->PageNo().'/{nb}',0,0,'C');
 }
}*/

$proceso = new Proc_exp_tradoc();
?>