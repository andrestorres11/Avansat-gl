<?php
class LisTransp
{
    var $conexion;

    function LisTransp($co, $us, $ca)
 		{
			  $this -> conexion = $co;
			  $this -> usuario = $us;
			  $this -> cod_aplica = $ca;
        switch($_POST[opcion])
        {
            case "1":
            {
              $this->filtros();
            }
            break;
            case "2":
				      $this ->listar();
            break;
						case "3":
				      $this ->infoTarifa();
            break;
            default:
            {
            	$this->filtros();
            }
            break;
        }
    }



    function filtros()
    {
        $tipos[0][0] = 0;
        $tipos[0][1] = "-";
				$tipos[1][0] = 'N';
        $tipos[1][1] = "Novedades";
				$tipos[2][0] = 'D';
        $tipos[2][1] = "Despachos";
        
				$estado[0][0] = 0;
        $estado[0][1] = "-";
				$estado[1][0] = 'A';
        $estado[1][1] = "Activo";
				$estado[2][0] = 'I';
        $estado[2][1] = "Inactivo";
				
				$inicio[0][0] = "";
        $inicio[0][1] = "-";
				
				
				$query= "SELECT a.cod_tercer, a.abr_tercer
           			 FROM ".BASE_DATOS.".tab_tercer_tercer a,
								 			".BASE_DATOS.".tab_transp_tarifa b
					 			 WHERE a.cod_tercer = b.cod_tercer  
								 GROUP BY 1";
  			$consulta = new Consulta($query, $this -> conexion);
				$transp = $consulta -> ret_matriz();
				$transp = array_merge($inicio, $transp);
				
				
        echo "<script language=\"JavaScript\" src=\"../".DIR_APLICA_CENTRAL."/js/new_ajax.js\"></script>\n";
        echo "<script language=\"JavaScript\" src=\"../".DIR_APLICA_CENTRAL."/js/functions.js\"></script>\n";
        echo "<script language=\"JavaScript\" src=\"../".DIR_APLICA_CENTRAL."/js/tarifa.js\"></script>\n";
				echo "<script language=\"JavaScript\" src=\"../".DIR_APLICA_CENTRAL."/js/min.js\"></script>\n";
			  echo "<script language=\"JavaScript\" src=\"../".DIR_APLICA_CENTRAL."/js/jquery.js\"></script>\n";
			  echo "<script language=\"JavaScript\" src=\"../".DIR_APLICA_CENTRAL."/js/es.js\"></script>\n";
			  echo "<script language=\"JavaScript\" src=\"../".DIR_APLICA_CENTRAL."/js/time.js\"></script>\n";
			  echo "<script language=\"JavaScript\" src=\"../".DIR_APLICA_CENTRAL."/js/mask.js\"></script>\n";
			  echo "<link rel='stylesheet' href='../".DIR_APLICA_CENTRAL."/estilos/jquery.css' type='text/css'>";
			  echo '
			   <script>
			     jQuery(function($) { 
			       $( "#fec_creiniID,#fec_crefinID" ).datepicker();      
			       $.mask.definitions["A"]="[12]";
			       $.mask.definitions["M"]="[01]";
			       $.mask.definitions["D"]="[0123]";
			       $.mask.definitions["H"]="[012]";
			       $.mask.definitions["N"]="[012345]";
			       $.mask.definitions["n"]="[0123456789]";
			       $( "#fec_creiniID,#fec_crefinID" ).mask("Annn-Mn-Dn");
					});
				 </script>';	
				$formulario = new Formulario("index.php\" enctype=\"multipart/form-data\"", "post", "LISTAR TARIFAS POR EMPRESA", "form\" id=\"formularioID");
			  $formulario -> nueva_tabla();
				$formulario -> texto ("Fecha de Inicio de Factura","text","fec_creini\" id=\"fec_creiniID",0,7,7,"","" );
				$formulario -> texto ("Fecha de Final de Factura","text","fec_crefin\" id=\"fec_crefinID",1,7,7,"","" );
        $formulario -> lista( "Tipo de Cobro:","tip_tarifa\" id=\"tip_tarifaID",$tipos,0);
				$formulario -> lista( "Transportadora:","cod_tercer\" id=\"cod_tercerID",$transp,1);
        $formulario -> lista( "Estado:","ind_estado\" id=\"ind_estadoID",$estado,1);
				$formulario -> nueva_tabla();
				$formulario -> boton("Buscar","button\" onClick=\" form.opcion.value=2;form.submit()",0);
        $formulario -> oculto("url_archiv\" id=\"url_archivID\"","ins_client_emailx.php",0);
		    $formulario -> oculto("dir_aplica\" id=\"dir_aplicaID\"",DIR_APLICA_CENTRAL,0);
        $formulario -> oculto("window","central",0);
        $formulario -> oculto("cod_servic",$GLOBALS["cod_servic"],0);
        $formulario -> oculto("opcion\" id=\"opcionID",1,0);
        
				$formulario -> cerrar();
        
    }

  
	

    function listar()
    {
        include( "../".DIR_APLICA_CENTRAL."/lib/general/dinamic_list.inc" );

        echo "<link rel=\"stylesheet\" href=\"../".DIR_APLICA_CENTRAL."/estilos/dinamic_list.css\" type=\"text/css\">";
        echo "<script language=\"JavaScript\" src=\"../".DIR_APLICA_CENTRAL."/js/dinamic_list.js\"></script>\n";
        echo "<script language=\"JavaScript\" src=\"../".DIR_APLICA_CENTRAL."/js/new_ajax.js\"></script>\n";
        echo "<script language=\"JavaScript\" src=\"../".DIR_APLICA_CENTRAL."/js/tarifa.js\"></script>\n";

        $formulario = new Formulario("index.php\" enctype=\"multipart/form-data\"", "post", "LISTAR TARIFAS POR EMPRESA", "formulario");
        $sql = "SELECT a.cod_tarifa, b.abr_tercer, if(a.tip_tarifa='N','NOVEDADES','DESPACHOS'),
											 a.val_minimo, DATE_FORMAT(a.fec_creaci,'%d-%m-%Y'),
											 if(a.ind_estado = '1','Activa','Inactiva')
                FROM ".BASE_DATOS.".tab_transp_tarifa a, 
                		 ".BASE_DATOS.".tab_tercer_tercer b
								WHERE 1 = 1 AND
											a.cod_tercer = b.cod_tercer ";
        if($GLOBALS['tip_tarifa'])
          $sql .= " AND a.tip_tarifa = '".$GLOBALS['tip_tarifa']."' ";
				if($GLOBALS['cod_tercer'])
          $sql .= " AND a.cod_tercer = '".$GLOBALS['cod_tercer']."' ";	
				if($GLOBALS['fec_creini'] && $GLOBALS['fec_crefin'])
          $sql .= " AND a.fec_creaci >= '".$GLOBALS['fec_creini']."' AND  a.fec_creaci <= '".$GLOBALS['fec_crefin']."'";
				if($GLOBALS['ind_estado']){
					if($GLOBALS['ind_estado']=='A')
          	$sql .= " AND a.ind_estado ='1'";	 
					if($GLOBALS['ind_estado']=='I')
          	$sql .= " AND a.ind_estado ='0'";	 
				}

        $list = new DinamicList($this->conexion, $sql, 1 );
        $list->SetClose('no');
        $list->SetHeader("Consecutivo", "field:a.cod_tarifa; type:link; onclick:infoTarifa()");
        $list->SetHeader("TRansportadora", "field:a.cod_tercer");
				$list->SetHeader("Tipo", "field:a.tip_tarifa");
				$list->SetHeader("Valor Minimo", "field:a.val_minimo");
        $list->SetHeader("Fecha", "field:a.fec_creaci");
				$list->SetHeader("Estado", "field:a.ind_estado");
        $list->Display($this->conexion);

        $_SESSION["DINAMIC_LIST"] = $list;
        echo "<td>";
        echo $list->GetHtml();
        echo "</td>";

        $formulario -> nueva_tabla();
        $formulario -> oculto("url_archiv\" id=\"url_archivID\"","lis_tarifa_transp.php",0);
		    $formulario -> oculto("dir_aplica\" id=\"dir_aplicaID\"",DIR_APLICA_CENTRAL,0);
        $formulario -> oculto("window","central",0);
        $formulario -> oculto("cod_servic",$GLOBALS["cod_servic"],0);
        $formulario -> oculto("opcion",2,0);

        $formulario -> cerrar();
        
        echo '<tr><td><div id="AplicationEndDIV"></div>
              <div id="RyuCalendarDIV" style="position: absolute; background: white; left: 0px; top: 0px; z-index: 3; display: none; border: 1px solid black; "></div>
              <div id="popupDIV" style="position: absolute; left: 0px; top: 0px; width: 300px; height: 300px; z-index: 3; visibility: hidden; overflow: auto; border: 5px solid #333333; background: white; ">

    		  <div id="filtros" >
    		  </div>

    		  <div id="result" >


    		  </div>
     		  </div><div id="alg"> <table></table></div></td></tr>';
			echo"";
    }

	function infoTarifa()
 	{
    ini_set('display_errors', true);
		error_reporting(E_ALL & ~E_NOTICE);
		global $HTTP_POST_FILES;
		session_start();
		$BASE = $_SESSION[BASE_DATOS];
		define ('DIR_APLICA_CENTRAL', $_SESSION['DIR_APLICA_CENTRAL']);
    define ('ESTILO', $_SESSION['ESTILO']);
    define ('BASE_DATOS', $_SESSION['BASE_DATOS']);
		include( "../lib/general/conexion_lib.inc" );
		include( "../lib/general/form_lib.inc" );
		include( "../lib/general/tabla_lib.inc" );
		echo "<script language=\"JavaScript\" src=\"../".DIR_APLICA_CENTRAL."/js/tarifa.js\"></script>\n";
		$this -> conexion = new Conexion( "localhost", $_SESSION[USUARIO], $_SESSION[CLAVE], $BASE  );//cod_transp
		$query = "SELECT a.cod_tarifa, if(a.tip_tarifa='N','NOVEDADES','DESPACHOS'),
										 a.val_minimo, DATE_FORMAT(a.fec_creaci,'%d-%m-%Y'),
										 if(a.ind_estado = '1','Activa','Inactiva'), b.abr_tercer,
										 DATE_FORMAT(fec_inifac,'%d-%m-%Y'), DATE_FORMAT(fec_finfac,'%d-%m-%Y')
              FROM ".BASE_DATOS.".tab_transp_tarifa a,
									 ".BASE_DATOS.".tab_tercer_tercer b  
              WHERE a.cod_tarifa = '".$_POST['cod_tarifa']."' AND
										a.cod_tercer = b.cod_tercer ";
		$consulta = new Consulta($query, $this -> conexion);
		$tarifa = $consulta -> ret_matriz();						
		$formulario = new Formulario("index.php\" enctype=\"multipart/form-data\"", "post", "DETALLE TARIFA POR TRANSPORTADORA", "form_insert\" id=\"formularioID");
    $formulario -> nueva_tabla();
		$formulario -> linea("Tipo de Cobro",0,"t2");
		$formulario -> linea($tarifa[0][1],0,"t");
		$formulario -> linea("Transportadora",0,"t2");
		$formulario -> linea($tarifa[0][4],1,"t");
		$formulario -> linea("Valor Minimo",0,"t2");
		$formulario -> linea(number_format($tarifa[0][2],0),0,"t");
		$formulario -> linea("Fecha de Creacion",0,"t2");
		$formulario -> linea($tarifa[0][3],1,"t");
		$formulario -> linea("Fecha de Facturacion Inicial",0,"t2");
		$formulario -> linea($tarifa[0][5],0,"t");
		$formulario -> linea("Fecha de Facturacion Final",0,"t2");
		$formulario -> linea($tarifa[0][6],1,"t");
		$formulario -> linea("Estado",0,"t2");
		$formulario -> linea($tarifa[0][4],0,"t");
    
		if($tarifa[0][1]=='DESPACHOS'){
			$query= "SELECT val_tarifa
         			 FROM ".BASE_DATOS.".tab_transp_tardell
				 			 WHERE cod_tarifa= '".$_POST['cod_tarifa']."' ";
			$consulta = new Consulta($query, $this -> conexion);
			$val_tarifa = $consulta -> ret_matriz();
			$formulario -> linea("Valor Despachos",0,"t2");
			$formulario -> linea(number_format($val_tarifa[0][0],0),1,"t");
		}
		if($tarifa[0][1]=='NOVEDADES'){
			$query= "SELECT can_minimo, can_maximo, val_tarifa
         			 FROM ".BASE_DATOS.".tab_transp_tardell
				 			 WHERE cod_tarifa= '".$_POST['cod_tarifa']."' ";
			$consulta = new Consulta($query, $this -> conexion);
			$detall = $consulta -> ret_matriz();
			$formulario -> nueva_tabla();
			
			echo '<td align="center" colspan="0" style="padding:4px;" class="celda_etiqueta">
							Cantidad Minima</td>';
			echo '<td align="center" colspan="0" style="padding:4px;" class="celda_etiqueta">
							Cantidad Maxima</td>';
			echo '<td align="center" colspan="0" style="padding:4px;" class="celda_etiqueta">
							Valor
							&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>';								
			echo "</tr>";
			$j=0;
			$formulario -> nueva_tabla();
			echo '<tr ><td width="100%"><div id="AplicationEndDIV" width="100%"></div>
          <div id="RyuCalendarDIV" width="100%"></div>
          <div id="popupDIV" width="100%">

		  <div id="filtros" width="100%">
			
		  </div><div id="tarifasID" width="100%">';
				for( $i=0; $i < sizeof( $detall ); $i++ )
				{	
					echo 	"<table id='tarifas".$i."ID' width='100%'>";
					//echo "<td class='celda_etiqueta' style='padding:4px;'   colspan='0' > </td>";		
					echo "<td align='center'   class='celda_info' style='padding:4px;'   colspan='0' >
									<input class='campo_texto' style='backgroun:none;border:0' readonly='true' value=".$detall[$i][0]."  type='text' size='5' maxlength='5' 
					 				name='can_minimo[]'    /></td>";
					echo "<td align='center' class='celda_info'  style='padding:4px;'   colspan='0' >
									<input class='campo_texto' style='backgroun:none;border:0' readonly='true' value=".$detall[$i][1]."  type='text' size='5' maxlength='5' 
					 				name='can_maximo[]'   /></td>";
					echo "<td align='center' class='celda_info'  style='padding:4px;'   colspan='0' >
									<input class='campo_texto' style='backgroun:none;border:0' readonly='true' type='text' value=".number_format($detall[$i][2])."  size='10' maxlength='10' 
					 				name='val_tarifa[]'   /></td>";								
					echo "</tr></table>";
					
				}
		}
		$formulario -> nueva_tabla();
		$formulario -> boton("Cerrar","button\" onClick=\"ClosePopup()",0);
    $formulario -> oculto("window","central",0);
    $formulario -> oculto("cod_servic",$GLOBALS["cod_servic"],0);
    $formulario -> oculto("opcion\" id=\"opcionID",3,0);
    $formulario -> cerrar();
	}
}
$service = new LisTransp($this -> conexion, $this -> usuario_aplicacion, $this-> codigo);
?> 
